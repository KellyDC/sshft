name: CI

on:
  push:
    branches: [main, develop/*]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action.yml syntax
        run: |
          # Validate YAML syntax using Python
          python3 << 'PYEOF'
          import yaml
          import sys

          try:
              with open('action.yml', 'r') as f:
                  action = yaml.safe_load(f)
              print("✅ action.yml syntax is valid")
          except yaml.YAMLError as e:
              print(f"❌ action.yml has invalid YAML syntax: {e}")
              sys.exit(1)
          PYEOF

      - name: Validate action structure
        run: |
          # Check required fields using Python
          python3 << 'PYEOF'
          import yaml
          import sys

          with open('action.yml', 'r') as f:
              action = yaml.safe_load(f)

          # Check required fields
          required_fields = ['name', 'description', 'runs', 'branding']
          for field in required_fields:
              if field not in action:
                  print(f"❌ Missing required field: {field}")
                  sys.exit(1)

          # Validate inputs have descriptions
          if 'inputs' in action and action['inputs']:
              for input_name, input_details in action['inputs'].items():
                  if not input_details.get('description'):
                      print(f"❌ Input '{input_name}' missing description")
                      sys.exit(1)

          print("✅ Action structure is valid")
          PYEOF

      - name: Check shell script syntax
        run: |
          echo "Validating shell scripts in action.yml..."

          # Check for common shell script issues
          VALIDATION_FAILED=false

          # Check for unmatched quotes in action.yml
          if grep -n '"[^"]*$' action.yml | grep -v '#' | grep -v '|'; then
            echo "⚠️  Potential unmatched quotes found"
          fi

          # Verify action.yml is valid YAML and has steps
          python3 << 'PYEOF'
          import yaml
          import sys

          try:
              with open('action.yml', 'r') as f:
                  action = yaml.safe_load(f)
              
              if 'runs' not in action or 'steps' not in action['runs']:
                  print("❌ No steps found in action.yml")
                  sys.exit(1)
              
              step_count = len(action['runs']['steps'])
              print(f"✅ Found {step_count} steps in action")
          except Exception as e:
              print(f"❌ Failed to parse action.yml: {e}")
              sys.exit(1)
          PYEOF

          # Check for dangerous patterns
          if grep -n 'rm -rf \$' action.yml; then
            echo "⚠️  Found potentially dangerous rm command with variables"
          fi

          if [ "$VALIDATION_FAILED" = "true" ]; then
            exit 1
          fi

          echo "✅ Shell script validation completed"

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential hardcoded secrets..."

          # Check for common secret patterns in code
          SECRET_FOUND=false

          # Check for potential AWS keys (exclude workflows to avoid false positives)
          if grep -r -E "AKIA[0-9A-Z]{16}" --include="*.yml" --include="*.yaml" --include="*.sh" --include="*.md" --exclude-dir=.github .; then
            echo "⚠️  Potential AWS access key found"
            SECRET_FOUND=true
          fi

          # Check for potential private keys in non-test files (exclude workflows and tests)
          if grep -r "BEGIN.*PRIVATE KEY" --include="*.yml" --include="*.yaml" --include="*.sh" --exclude-dir=test* --exclude-dir=.github .; then
            echo "⚠️  Potential private key found"
            SECRET_FOUND=true
          fi

          # Check for hardcoded passwords (exclude workflows)
          if grep -r -iE "password\s*=\s*['\"][^'\"]+['\"]" --include="*.yml" --include="*.yaml" --include="*.sh" --exclude-dir=.github .; then
          fi

          echo "✅ No obvious secrets detected"

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint shell scripts with ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "."
          format: gcc
          severity: warning

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: action.yml .github/workflows/
          config_file: .yamllint.yml

  test:
    runs-on: ubuntu-latest
    needs: [validate, security-scan, lint]

    strategy:
      matrix:
        test-scenario:
          - upload-file
          - upload-directory
          - download-file
          - download-directory

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          # Create test files and directories
          mkdir -p test_data/upload test_data/download
          echo "Test file content $(date)" > test_data/upload/test_file.txt
          mkdir -p test_data/upload/subdir
          echo "Subdirectory file" > test_data/upload/subdir/sub_file.txt

          # Generate test SSH key (for validation only)
          ssh-keygen -t rsa -b 2048 -f test_key -N "" -C "test@example.com"
          echo "Test SSH key generated"

      - name: Validate action inputs
        run: |
          # Test that action would fail with invalid inputs
          echo "Testing input validation..."

          # This should work (we're not actually connecting, just validating structure)
          python3 -c "
          import yaml
          import sys

          with open('action.yml', 'r') as f:
              action = yaml.safe_load(f)

          required_inputs = []
          for name, details in action.get('inputs', {}).items():
              if details.get('required', False):
                  required_inputs.append(name)

          print(f'Required inputs: {required_inputs}')

          # Validate that all required inputs are documented
          expected_required = ['host', 'username', 'key', 'source', 'destination']
          for req in expected_required:
              if req not in required_inputs:
                  print(f'ERROR: {req} should be required')
                  sys.exit(1)

          print('✅ Input validation passed')
          "

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action workflow
        run: |
          echo "Validating action workflow structure..."

          # Check that action.yml has all required composite action fields
          python3 << 'PYEOF'
          import yaml
          import sys

          with open('action.yml', 'r') as f:
              action = yaml.safe_load(f)

          # Check composite runner
          if action.get('runs', {}).get('using') != 'composite':
              print("❌ Action must use 'composite' runner")
              sys.exit(1)

          # Count steps
          step_count = len(action.get('runs', {}).get('steps', []))
          print(f"Found {step_count} steps in action")

          if step_count == 0:
              print("❌ No steps found in action")
              sys.exit(1)

          # Check that critical steps exist
          step_names = [step.get('name', '') for step in action['runs']['steps']]

          if not any('SSH' in name for name in step_names):
              print("❌ Missing SSH setup step")
              sys.exit(1)

          print("✅ Action workflow structure is valid")
          print("Note: Full integration testing requires SSH server (run manually)")
          PYEOF

  documentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation completeness
        run: |
          # Check if README.md exists and has required sections
          if [ ! -f README.md ]; then
            echo "❌ README.md not found"
            exit 1
          fi

          REQUIRED_SECTIONS=("Inputs" "Example Usage" "Security Notes")
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "## $section" README.md; then
              echo "❌ Missing required section in README.md: $section"
              exit 1
            fi
          done

          echo "✅ Documentation is complete"

      - name: Validate examples in README
        run: |
          # Extract YAML examples from README and validate syntax
          echo "Validating YAML examples in README..."

          # This is a simplified check - in practice you'd extract and validate each YAML block
          if grep -q "uses: kellydc/sshft@" README.md; then
            echo "✅ README contains proper usage examples"
          else
            echo "❌ README missing usage examples"
            exit 1
          fi
